# OAuth2 Migration Changelog

## Summary

Migrated Google Drive integration from **Service Account** to **OAuth2 Client** authentication to support free Google accounts.

## Why This Change?

❌ **Old (Service Accounts)**:
- Does NOT work with free Google accounts
- Requires paid Google Workspace
- Complex setup with service account emails
- No user-friendly interface

✅ **New (OAuth2)**:
- Works with FREE personal Google accounts ✨
- User-friendly file upload interface
- Secure credential storage with encryption
- Built-in Settings page in the app

## What Changed

### Backend Changes

#### New Files
1. **`server/models/DriveCredentials.js`**
   - MongoDB model for storing OAuth2 credentials
   - AES-256 encryption for sensitive data (tokens, secrets)
   - Singleton pattern (one config per app)
   - Status tracking: `not_configured`, `credentials_uploaded`, `needs_authorization`, `active`, `error`

2. **`server/routes/drive.js`**
   - Complete Drive configuration API
   - Endpoints for credential/token upload
   - OAuth2 authorization flow
   - Connection testing
   - Configuration reset

#### Modified Files
1. **`server/services/cloudStorage.js`**
   - Changed from Service Account JWT to OAuth2 client
   - Reads credentials from MongoDB instead of env variables
   - Automatic token refresh handling
   - Stores refreshed tokens back to database

2. **`server/services/scheduler.js`**
   - Checks Drive config from database
   - Only uploads if `enabled` and `accessToken` present

3. **`server/routes/episodes.js`**
   - Added DriveCredentials check before upload
   - Uses database config instead of env variable

4. **`server/index.js`**
   - Added `/api/drive` routes

5. **`package.json`**
   - Added `multer` dependency for file uploads

### Frontend Changes

#### New Files
1. **`src/pages/Settings.jsx`**
   - Complete Google Drive setup wizard
   - 3-step configuration process:
     1. Upload credentials JSON
     2. Authorize (browser or token file)
     3. Set folder ID
   - Status badges and error display
   - Test connection button
   - Enable/disable toggle
   - Comprehensive instructions

#### Modified Files
1. **`src/App.jsx`**
   - Added `/settings` route

2. **`src/components/Layout.jsx`**
   - Added Settings link to navigation

3. **`src/services/api.js`**
   - Added 8 new Drive API functions:
     - `getDriveConfig()`
     - `uploadCredentials()`
     - `uploadToken()`
     - `getAuthUrl()`
     - `setFolderId()`
     - `toggleDrive()`
     - `testConnection()`
     - `resetDriveConfig()`

### Configuration Changes

#### Environment Variables
**Removed**:
```env
GOOGLE_CLIENT_EMAIL=
GOOGLE_PRIVATE_KEY=
GOOGLE_DRIVE_FOLDER_ID=
```

**Added**:
```env
ENCRYPTION_KEY=<auto-generated-32-byte-hex>
```

**Note**: OAuth2 credentials are now stored in MongoDB, not .env file!

### Database Changes

#### New Collection
- **`drivecredentials`** - Stores encrypted OAuth2 data:
  - Client ID & Secret
  - Access & Refresh Tokens
  - Folder ID
  - Status and error messages
  - Original JSON files (encrypted)

## Migration Guide

### For New Users
Just follow the Settings page wizard - no migration needed!

### For Existing Users (with Service Account)

1. **Keep your old credentials** (just in case)

2. **Start fresh**:
   ```bash
   # Start the app
   npm run dev
   
   # Navigate to Settings in the browser
   # Follow the 3-step wizard
   ```

3. **Create OAuth2 credentials**:
   - Go to Google Cloud Console
   - Create OAuth 2.0 Client ID (Desktop or Web app)
   - Download JSON file

4. **Upload and authorize**:
   - Upload credentials.json in Settings
   - Click "Authorize with Google"
   - Grant permissions
   - Set your folder ID

5. **Done!** Test connection and enable uploads

### Cleanup (Optional)
After verifying everything works, you can:
- Remove service account JSON files
- Delete service account from Google Cloud
- Remove old env variables from `.env`

## API Changes

### New Endpoints

```
GET    /api/drive/config           - Get Drive status
POST   /api/drive/credentials      - Upload credentials file
POST   /api/drive/token            - Upload token file
GET    /api/drive/auth-url         - Get OAuth URL
GET    /api/drive/callback         - OAuth callback (auto)
POST   /api/drive/folder           - Set folder ID
POST   /api/drive/toggle           - Enable/disable
POST   /api/drive/test             - Test connection
DELETE /api/drive/config           - Reset config
```

### Deprecated
- Service account env variables no longer used
- `STORAGE_PROVIDER` env still used for local vs cloud choice

## Security Improvements

### Encryption
- All sensitive data encrypted with AES-256-CBC
- Unique 32-byte encryption key per installation
- Stored in `.env` (never committed to git)

### What's Encrypted
- Client secret
- Access token
- Refresh token
- Original credentials JSON
- Original token JSON

### What's NOT Encrypted
- Client ID (not sensitive)
- Redirect URI (public)
- Folder ID (not sensitive)
- Status fields

## User Experience Improvements

### Before (Service Account)
1. Create project in Google Cloud ❌ Complex
2. Create service account ❌ Technical
3. Download JSON key ❌ Confusing
4. Extract fields manually ❌ Error-prone
5. Paste into .env ❌ No validation
6. Share folder with service email ❌ Extra step
7. Hope it works ❌ No testing

### After (OAuth2)
1. Create project in Google Cloud ✅ Still needed
2. Create OAuth client ✅ Simpler
3. Download JSON ✅ One file
4. **Upload in Settings UI** ✅ Visual feedback
5. **Click "Authorize"** ✅ One click!
6. **Set folder ID** ✅ No sharing needed
7. **Test connection** ✅ Built-in validation

## Testing

To test the new OAuth2 flow:

```bash
# 1. Install dependencies
npm install

# 2. Generate encryption key (if not done)
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
# Add to .env as ENCRYPTION_KEY

# 3. Start the app
npm run dev

# 4. Open Settings
# http://localhost:3000/settings

# 5. Follow wizard
# - Upload credentials.json
# - Click "Authorize with Google"
# - Set folder ID
# - Test connection
```

## Troubleshooting

See `GOOGLE_DRIVE_SETUP.md` for detailed troubleshooting guide.

Common issues:
- **Invalid credentials**: Make sure you downloaded OAuth2 (not API key)
- **Authorization failed**: Add yourself as test user in consent screen
- **Connection failed**: Token expired - re-authorize

## Breaking Changes

⚠️ **If you were using service accounts**, you'll need to:
1. Reconfigure using OAuth2 (follow Settings wizard)
2. Remove old env variables
3. Your old uploads will remain in Drive

## Benefits Summary

✅ Works with free Google accounts  
✅ User-friendly web interface  
✅ Automatic token refresh  
✅ Secure encrypted storage  
✅ Status monitoring  
✅ Built-in testing  
✅ Better error messages  
✅ No more .env editing  
✅ Visual setup wizard  
✅ Multiple auth options  

## Files Added

```
server/models/DriveCredentials.js
server/routes/drive.js
src/pages/Settings.jsx
GOOGLE_DRIVE_SETUP.md
CHANGELOG_OAUTH2.md (this file)
```

## Files Modified

```
server/services/cloudStorage.js
server/services/scheduler.js
server/routes/episodes.js
server/index.js
src/App.jsx
src/components/Layout.jsx
src/services/api.js
package.json
.env
.env.example
README.md
```

---

**Need Help?** See `GOOGLE_DRIVE_SETUP.md` for step-by-step guide!
